version: '3.3'

x-log: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "10"

services:
  s3:
      <<: *logging
      privileged: true
      image: efrecon/s3fs
      restart: unless-stopped
      cap_add:
        - SYS_ADMIN
      security_opt:
        - 'apparmor:unconfined'
      devices:
        - /dev/fuse
      volumes:
        - /mnt/tmp:/opt/s3fs/bucket:rshared
        - ./.pass:/.pass
      env_file:
        - ./.env
      environment:
        AWS_S3_BUCKET: '${AWS_S3_BUCKET}'
        AWS_S3_ACCESS_KEY_ID: '${AWS_S3_ACCESS_KEY_ID}'
        AWS_S3_SECRET_ACCESS_KEY: '${AWS_S3_SECRET_ACCESS_KEY}'
        AWS_S3_AUTHFILE: '${AWS_S3_AUTHFILE}'
        AWS_S3_SECRET_ACCESS_KEY_FILE: '${AWS_S3_SECRET_ACCESS_KEY_FILE}'
        AWS_S3_URL: '${AWS_S3_URL}'
        AWS_S3_MOUNT: '/opt/s3fs/bucket'
        #S3FS_ARGS: 'allow_other'
        S3FS_DEBUG: 0
      # необходимо выставить под нужного пользователя и группу своего проекта
      # 
      #  UID: 1000
      #  GID: 1000
  orthanc:
      <<: *logging
      image: osimis/orthanc
      depends_on:
        - s3
      restart: always
      volumes:
        - /mnt/tmp:/var/lib/orthanc/db:rshared
        #учесть размещение на объемном диске
        - /tmp/Orthanc:/tmp/Orthanc
        - ./app/conf/conf.json:/etc/orthanc/conf.json
      ports:
        - "4242:4242"
        - "8042:8042"